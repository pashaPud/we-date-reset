<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è | WeDate</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1rem;
    }
    form {
      display: flex;
      flex-direction: column;
      max-width: 400px;
      width: 100%;
      gap: 1rem;
    }
    .input-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    input {
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input.error {
      border-color: #e74c3c;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: #666;
      padding: 0;
    }
    button {
      background: black;
      color: white;
      padding: 0.75rem;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 4px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 1rem;
      font-weight: bold;
    }
    .message.success {
      color: #27ae60;
    }
    .message.error {
      color: #e74c3c;
    }
    .requirements {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .requirements ul {
      margin: 0.5rem 0;
      padding-left: 1.2rem;
    }
    .requirements li {
      margin: 0.2rem 0;
    }
    .requirement-met {
      color: #27ae60;
    }
    .requirement-not-met {
      color: #e74c3c;
    }
  </style>
</head>
<body>
  <h1>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h1>
  <form id="resetForm">
    <div class="requirements">
      <strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:</strong>
      <ul>
        <li id="lengthReq" class="requirement-not-met">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</li>
      </ul>
    </div>
    
    <div class="input-container">
      <input type="password" id="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required />
      <button type="button" class="toggle-password" onclick="togglePassword('password')">üëÅÔ∏è</button>
    </div>
    
    <div class="input-container">
      <input type="password" id="confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required />
      <button type="button" class="toggle-password" onclick="togglePassword('confirm')">üëÅÔ∏è</button>
    </div>
    
    <button type="submit" id="submitBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</button>
    <div class="message" id="message"></div>
  </form>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://tfewdarpiwdelivlifuu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZXdkYXJwaXdkZWxpdmxpZnV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTg3ODMyODIsImV4cCI6MjAxNDM1OTI4Mn0.MR59uebNSQW5zUEskgK47v0-FgOp0Kr6Id8GyVmdmQs'
)

  const form = document.getElementById('resetForm')
  const message = document.getElementById('message')
  const passwordInput = document.getElementById('password')
  const confirmInput = document.getElementById('confirm')
  const submitBtn = document.getElementById('submitBtn')
  const lengthReq = document.getElementById('lengthReq')

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
  window.togglePassword = function(inputId) {
    const input = document.getElementById(inputId)
    const type = input.getAttribute('type') === 'password' ? 'text' : 'password'
    input.setAttribute('type', type)
    
    const button = input.nextElementSibling
    button.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà'
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function showMessage(text, type = 'error') {
    message.textContent = text
    message.className = `message ${type}`
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é
  function checkPasswordRequirements(password) {
    const isLengthValid = password.length >= 6
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    lengthReq.className = isLengthValid ? 'requirement-met' : 'requirement-not-met'
    
    return isLengthValid
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  passwordInput.addEventListener('input', function() {
    const password = this.value
    const isValid = checkPasswordRequirements(password)
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∏–ª—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
    this.classList.remove('error')
    
    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç
    if (message.classList.contains('error')) {
      message.textContent = ''
      message.className = 'message'
    }
  })

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
  confirmInput.addEventListener('input', function() {
    this.classList.remove('error')
    
    if (message.classList.contains('error')) {
      message.textContent = ''
      message.className = 'message'
    }
  })

  const hash = window.location.hash.substring(1)
  const params = new URLSearchParams(hash)
  const accessToken = params.get("access_token")
  const refreshToken = params.get("refresh_token")
  const type = params.get("type")

  console.log(
    "üîç Hash params ‚Üí access_token:",
    accessToken?.slice(0,8),
    "... type:",
    type
  )

  if (type === "recovery" && accessToken && refreshToken) {
    try {
      const { error } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
      })

      if (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ setSession:", error.message)
        showMessage("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + error.message, 'error')
        form.style.display = "none"
      } else {
        console.log("‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
      }
    } catch (err) {
      console.error("‚ùå Exception setSession:", err)
      showMessage("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ.", 'error')
      form.style.display = "none"
    }
  } else {
    console.warn("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è")
    showMessage("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–±—Ä–æ—Å–∞.", 'error')
    form.style.display = "none"
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const password = passwordInput.value
    const confirm = confirmInput.value

    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—à–∏–±–æ–∫
    passwordInput.classList.remove('error')
    confirmInput.classList.remove('error')

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –ø–∞—Ä–æ–ª—è
    if (!checkPasswordRequirements(password)) {
      passwordInput.classList.add('error')
      showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error')
      return
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
    if (password !== confirm) {
      confirmInput.classList.add('error')
      showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error')
      return
    }

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
    submitBtn.disabled = true
    submitBtn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...'

    try {
      const { error } = await supabase.auth.updateUser({ password })

      if (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ updateUser:", error.message)
        
        // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        let errorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è: "
        if (error.message.includes('session_not_found')) {
          errorMessage += "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –∑–∞–Ω–æ–≤–æ."
        } else if (error.message.includes('invalid_credentials')) {
          errorMessage += "–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."
        } else if (error.message.includes('too_many_requests')) {
          errorMessage += "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        } else {
          errorMessage += error.message
        }
        
        showMessage(errorMessage, 'error')
      } else {
        console.log("‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω")
        showMessage("–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ –∏ –≤–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.", 'success')
        form.reset()
        checkPasswordRequirements('') // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
      }
    } catch (err) {
      console.error("‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ updateUser:", err)
      showMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", 'error')
    } finally {
      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      submitBtn.disabled = false
      submitBtn.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å'
    }
  })
</script>

</body>
</html>
