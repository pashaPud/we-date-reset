<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è ‚Äì WeDate</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const params = new URLSearchParams(window.location.search)
    const token = params.get('access_token')
    const type = params.get('type')

    const status = document.getElementById('status')
    const form = document.getElementById('form')

    if (!token || type !== 'recovery') {
      status.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞.'
      form.style.display = 'none'
    } else {
      status.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.'

      document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault()
        const password = document.getElementById('password').value

        status.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏...'

        const { error: verifyError } = await supabase.auth.verifyOtp({
          type: 'recovery',
          token
        })

        if (verifyError) {
          status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ' + verifyError.message
          return
        }

        const { error: updateError } = await supabase.auth.updateUser({
          password
        })

        if (updateError) {
          status.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: ' + updateError.message
        } else {
          status.textContent = '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω üéâ'
          form.style.display = 'none'
        }
      })
    }
  </script>
</head>
<body style="font-family: sans-serif; padding: 2rem;">
  <h1>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h1>
  <p id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

  <form id="form" style="margin-top: 1rem;">
    <input id="password" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required minlength="6" style="padding: 0.5rem; width: 100%; max-width: 300px;" />
    <br /><br />
    <button type="submit" style="padding: 0.5rem 1rem;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  </form>
</body>
</html>
